<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Tankowania â€“ Wykres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, select, button { display: block; margin-top: 10px; width: 100%; padding: 6px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 100px; }
    canvas { max-width: 100%; margin-top: 20px; }
    @media (min-width: 600px) {
      form { max-width: 400px; }
    }
  </style>
</head>
<body>

<h1>Dodaj tankowanie</h1>

<form id="fuelForm">
  <label>Aktualny przebieg (km): <input type="number" id="currOdo" required></label>
  <label>IloÅ›Ä‡ paliwa (litry): <input type="number" step="0.01" id="liters" required></label>

  <div class="row">
    <div><label>Cena za caÅ‚oÅ›Ä‡ (zÅ‚): <input type="number" step="0.01" id="totalCost"></label></div>
    <div><label>Cena za litr (zÅ‚): <input type="number" step="0.01" id="pricePerLiter"></label></div>
  </div>

  <label>Rodzaj paliwa:
    <select id="fuelType">
      <option value="lpg" selected>LPG</option>
      <option value="benzyna">Benzyna</option>
    </select>
  </label>

  <label>Data tankowania:</label>
  <div class="row">
    <div><select id="day"></select></div>
    <div><select id="month"></select></div>
    <div><select id="year"></select></div>
  </div>

  <button type="submit">Zapisz tankowanie</button>
</form>

<button onclick="location.href='historia.html'">ðŸ“‹ PrzejdÅº do historii</button>

<canvas id="fuelChart"></canvas>

<script>
  // Inicjalizacja pÃ³l daty
  const today = new Date();
  const daySelect = document.getElementById("day");
  const monthSelect = document.getElementById("month");
  const yearSelect = document.getElementById("year");

  for (let i = 1; i <= 31; i++) {
    const opt = new Option(i.toString().padStart(2, '0'), i);
    if (i === today.getDate()) opt.selected = true;
    daySelect.append(opt);
  }

  for (let i = 1; i <= 12; i++) {
    const opt = new Option(i.toString().padStart(2, '0'), i);
    if (i === today.getMonth() + 1) opt.selected = true;
    monthSelect.append(opt);
  }

  const thisYear = today.getFullYear();
  for (let i = thisYear - 5; i <= thisYear + 1; i++) {
    const opt = new Option(i, i);
    if (i === thisYear) opt.selected = true;
    yearSelect.append(opt);
  }

  const form = document.getElementById("fuelForm");
  const chartCtx = document.getElementById("fuelChart").getContext("2d");
  let history = JSON.parse(localStorage.getItem("fuelHistory") || "[]");

  const chart = new Chart(chartCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Spalanie LPG', borderColor: 'green', data: [], yAxisID: 'y', tension: 0.3 },
        { label: 'Spalanie Benzyna', borderColor: 'red', data: [], yAxisID: 'y', tension: 0.3 },
        { label: 'Koszt/km LPG', borderColor: 'blue', data: [], yAxisID: 'y1', tension: 0.3 },
        { label: 'Koszt/km Benzyna', borderColor: 'orange', data: [], yAxisID: 'y1', tension: 0.3 }
      ]
    },
    options: {
      scales: {
        y: { title: { display: true, text: "l/100km" }, position: "left" },
        y1: { title: { display: true, text: "zÅ‚/km" }, position: "right", grid: { drawOnChartArea: false } }
      }
    }
  });

  function updateChart() {
    const labels = history.slice(1).map((_, i) => `#${i + 1}`);
    chart.data.labels = labels;
    chart.data.datasets[0].data = history.slice(1).map(e => e.rodzaj === 'lpg' ? e.spalanie : null);
    chart.data.datasets[1].data = history.slice(1).map(e => e.rodzaj === 'benzyna' ? e.spalanie : null);
    chart.data.datasets[2].data = history.slice(1).map(e => e.rodzaj === 'lpg' ? e.kosztZaKm : null);
    chart.data.datasets[3].data = history.slice(1).map(e => e.rodzaj === 'benzyna' ? e.kosztZaKm : null);
    chart.update();
  }

  form.addEventListener("submit", e => {
    e.preventDefault();

    const odo = parseFloat(document.getElementById("currOdo").value);
    const liters = parseFloat(document.getElementById("liters").value);
    const rodzaj = document.getElementById("fuelType").value;

    let totalCost = parseFloat(document.getElementById("totalCost").value);
    const pricePerLiter = parseFloat(document.getElementById("pricePerLiter").value);

    if (isNaN(totalCost) && isNaN(pricePerLiter)) {
      return alert("WprowadÅº cenÄ™ za litr lub za caÅ‚oÅ›Ä‡.");
    }

    if (isNaN(totalCost)) totalCost = liters * pricePerLiter;
    if (isNaN(pricePerLiter)) document.getElementById("pricePerLiter").value = (totalCost / liters).toFixed(2);

    const data = `${yearSelect.value}-${monthSelect.value.toString().padStart(2, '0')}-${daySelect.value.toString().padStart(2, '0')}`;

    if (!history.length) {
      history.push({ odo, data }); // pierwszy przebieg
      localStorage.setItem("fuelHistory", JSON.stringify(history));
      alert("Dodano pierwszy przebieg. Dodaj kolejne, by obliczyÄ‡ spalanie.");
      form.reset();
      return;
    }

    const last = history[history.length - 1];
    const dystans = odo - last.odo;
    if (dystans <= 0) return alert("Przebieg musi byÄ‡ wiÄ™kszy niÅ¼ poprzedni!");

    const spalanie = (liters / dystans) * 100;
    const kosztZaKm = totalCost / dystans;

    history.push({ data, rodzaj, dystans, spalanie, kosztZaKm, odo, litry: liters, koszt: totalCost });
    localStorage.setItem("fuelHistory", JSON.stringify(history));
    updateChart();
    form.reset();
  });

  updateChart();
</script>
</body>
</html>